name: Dev Branch deploy

on:
  push:
    branches:
      - 22-run-build-deploy-on-merge

jobs:
  deploy_job:
    runs-on: ubuntu-latest
    name: Build & Deploy to development branch on VIP Go
    env:
      DEPLOY_REPO: wpcomvip/wikimediafoundation-org
      DEPLOY_BRANCH: 22-run-build-deploy-on-merge-built
    steps:
      - name: Checkout this branch
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token

      - name: Lock PHP and composer versions
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "7.4"

      - name: Install Composer Dependencies
        uses: "ramsey/composer-install@v1"

      - name: Install npm dependencies
        uses: "bahmutov/npm-install@v1"
        with:
          working-directory: themes/shiro

      - name: Build assets
        run: (cd themes/shiro && npm run build)

      - name: Checkout deploy branch from upstream repo
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.DEPLOY_TOKEN }}
          ref: ${{ env.DEPLOY_BRANCH }}
          path: "deploy"
          # repository: ${{ env.DEPLOY_REPO }}

      - name: Rsync built archive into place
        run: |
          mv .deployignore .gitignore
          rm -rf .git .github vendor
          rsync -a --delete . deploy --exclude='deploy' --exclude='.git'

      - name: Commit changes & push to VIP
        run: |
          cd deploy
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A .
          git commit -m "Add built asset file changes" -a
          git push
