name: Dev Branch deploy

on:
  push:
    branches:
      - 22-run-build-deploy-on-merge

jobs:
  deploy_job:
    runs-on: ubuntu-latest
    name: Build & Deploy to development branch on VIP Go
    env:
      BRANCH: 22-run-build-deploy-on-merge
      REPO_SSH_URL: git@github.com:wpcomvip/wikimediafoundation-org.git
      BUILD_PATH: "/tmp/vip-go-build-${date +%s}"
    steps:
      - name: Checkout this branch
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

      - name: Lock PHP and composer versions
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "7.4"
          tools: composer:v1

      - name: Install Composer Dependencies
        uses: "ramsey/composer-install@v1"

      - name: Install npm dependencies
      - uses: "bahmutov/npm-install@v1"
        with:
          working-directory: thems/shiro

      - name: Build assets
        run: (cd themes/shiro && npm run build)

      - name: Checkout deploy branch from upstream repo
        uses: actions/checkout@v2
        with:
          repository: ${{ env.REPO_SSH_URL }}
          branch: 22-run-build-deploy-on-merge-built
          path: ${{ env.BUILD_PATH }}

      - name: Rsync all content into place in build directory, push it up.
        run: |
          rsync -a --delete . "$BUILD PATH" --exclude='.git'
          mv "${BUILD_PATH}/.deployignore" "${BUILD_PATH}.gitignore"

      - name: Commit changes & Push to VIP
        uses: "actions-js/push@master"
        with:
          github_token: ${{ secrets.DEPLOY_TOKEN }}
          branch: 22-run-build-deploy-on-merge-built
          directory: ${{ env.BUILD_PATH }}
