name: Dev Branch deploy

on:
  push:
    branches:
      - 22-run-build-deploy-on-merge

jobs:
  deploy_job:
    runs-on: ubuntu-latest
    name: Build & Deploy to development branch on VIP Go
    env:
      DEPLOY_REPO: wpcomvip/wikimediafoundation-org
      DEPLOY_BRANCH: 22-run-build-deploy-on-merge-built
    steps:
      - name: Checkout this branch
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

      - name: Lock PHP and composer versions
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "7.4"
          tools: composer:v1

      - name: Install Composer Dependencies
        uses: "ramsey/composer-install@v1"

      - name: Install npm dependencies
        uses: "bahmutov/npm-install@v1"
        with:
          working-directory: themes/shiro

      - name: Build assets
        run: (cd themes/shiro && npm run build)

      - name: Rsync all content into place in tmp directory
        run: |
          mv .deployignore .gitignore
          rsync -a --delete . ${{ runner.temp }} --exclude='.git'

      - name: Checkout deploy branch from upstream repo
        uses: actions/checkout@v2
        with:
          github_token: ${{ secrets.DEPLOY_TOKEN }}
          ref: ${{ env.DEPLOY_BRANCH }}
          path: "deploy"
          # repository: ${{ env.DEPLOY_REPO }}

      - name: Rsync all content into place in tmp directory
        run: |
          rsync -a --delete ${{ runner.temp }}.* deploy --exclude='.git'

      - name: Commit changes & Push to VIP
        uses: "actions-js/push@master"
        with:
          github_token: ${{ secrets.DEPLOY_TOKEN }}
          branch: ${{ env.DEPLOY_BRANCH }}
          directory: "deploy"
          # repository: ${{ env.DEPLOY_REPO }}
